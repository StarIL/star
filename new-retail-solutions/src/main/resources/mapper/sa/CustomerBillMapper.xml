<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shiwulian.wechat.mapper.sa.CustomerBillMapper">
  <!-- 映射应收账单POJO类 -->
  <resultMap id="BaseResultMap" type="com.shiwulian.wechat.bean.sa.CustomerBill">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="bill_code" jdbcType="VARCHAR" property="billCode" />
    <result column="bill_date" jdbcType="DATE" property="billDate" />
    <result column="period_date" jdbcType="DATE" property="periodDate" />
    <result column="customer_id" jdbcType="VARCHAR" property="customerId" />
    <result column="partner_id" jdbcType="VARCHAR" property="partnerId" />
    <result column="amount" jdbcType="DECIMAL" property="amount" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="confirm_time" jdbcType="TIMESTAMP" property="confirmTime" />
    <result column="confirm_operator" jdbcType="VARCHAR" property="confirmOperator" />
    <result column="pay_time" jdbcType="TIMESTAMP" property="payTime" />
    <result column="pay_operator" jdbcType="VARCHAR" property="payOperator" />
    <result column="invoice_id" jdbcType="VARCHAR" property="invoiceId" />
    <result column="create_operator" jdbcType="VARCHAR" property="createOperator" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="upt_operator" jdbcType="VARCHAR" property="uptOperator" />
    <result column="upt_time" jdbcType="TIMESTAMP" property="uptTime" />
    <result column="is_del" jdbcType="BIT" property="isDel" />
    <result column="currency_id" jdbcType="INTEGER" property="currencyId" /><!-- 币种ID -->
    <result column="invoice_amount" jdbcType="DECIMAL" property="invoiceAmount" /><!-- 开票金额(冗余) -->
    <result column="invoice_iscomplete" jdbcType="BIT" property="invoiceIscomplete" /><!-- 开票完成 -->
    <result column="bill_type" jdbcType="BIT" property="billType" /><!-- 类型：0、客户；1、拍档 -->
    <result column="paypartner_id" jdbcType="VARCHAR" property="paypartnerId" /><!-- 应付拍档ID -->
    <result column="outbank_id" jdbcType="VARCHAR" property="outbankId" /><!-- 支付银行ID -->
    <result column="inbank_id" jdbcType="VARCHAR" property="inbankId" /><!-- 收款银行ID -->
    <result column="expected_days" jdbcType="INTEGER" property="expectedDays" /><!-- 收款银行ID -->
  </resultMap>
  
  <!-- 查询字段列表 -->
  <sql id="Base_Column_List">
    id, bill_code, bill_date, period_date, customer_id, partner_id, amount, status, confirm_time, 
    confirm_operator, pay_time, pay_operator, invoice_id, create_operator, create_time, 
    upt_operator, upt_time, is_del, currency_id, invoice_amount, invoice_iscomplete, bill_type, 
    paypartner_id, outbank_id, inbank_id
  </sql>
  
  <!-- 按主键查询 -->
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from sa_customer_bill
    where id = #{id,jdbcType=VARCHAR}
  </select>
  
  <!-- 关联结算明细查询 -->
  <select id="selectByMapParam" resultMap="BaseResultMap" parameterType="map">
	select distinct 
	x.id, x.bill_code, x.bill_date, x.period_date, x.customer_id, x.partner_id, x.amount, x.status, x.confirm_time, 
    x.confirm_operator, x.pay_time, x.pay_operator, x.invoice_id, x.create_operator, x.create_time, x.upt_operator, 
    x.upt_time, x.is_del, x.currency_id, x.invoice_amount, x.invoice_iscomplete, x.bill_type, x.paypartner_id, 
    x.outbank_id, x.inbank_id
	from sa_customer_bill x, od_order_settlement y
    where x.id = y.income_billid and x.is_del = 0 and y.is_del = 0
	<if test="partnerId != null and partnerId != ''">
		and x.partner_id = #{partnerId,jdbcType=VARCHAR}
	</if>
	<if test="customerId != null and customerId != ''">
		and x.customer_id = #{customerId,jdbcType=VARCHAR}
	</if>
	<if test="billCode != null and billCode != ''">
		and x.bill_code like concat('%',#{billCode,jdbcType=VARCHAR},'%')
	</if>
	<if test="orderCode != null and orderCode != ''">
		and y.order_code like concat('%',#{orderCode,jdbcType=VARCHAR},'%')
	</if>
	<if test="billDateBegin != null and billDateBegin != ''">
		and x.bill_date <![CDATA[ >= ]]> #{billDateBegin,jdbcType=VARCHAR}
	</if>
	<if test="billDateEnd != null and billDateEnd != ''">
		and x.bill_date <![CDATA[ <= ]]> #{billDateEnd,jdbcType=VARCHAR}
	</if>
	<if test="status != null">
		<foreach collection="status" index="index" item="item" open="and (" close=")" separator=" or ">
			x.status = #{item}
		</foreach>
	</if>
	<if test="invoiceIscomplete != null">
		and x.invoice_iscomplete = #{invoiceIscomplete,jdbcType=BIT}
	</if>
	order by case when x.upt_time is not null then x.upt_time else x.create_time end desc
  </select>
  
  <!-- 单表条件查询 -->
  <select id="selectCustomerBillList"  resultMap="BaseResultMap" parameterType="map">
    select 
    t.id, t.bill_code, t.bill_date, t.period_date, t.customer_id, t.partner_id, t.amount, t.status, t.confirm_time, 
    t.confirm_operator, t.pay_time, t.pay_operator, t.invoice_id, t.create_operator, t.create_time, 
    t.upt_operator, t.upt_time, t.is_del, t.currency_id, t.invoice_amount, t.invoice_iscomplete, t.bill_type, 
    t.paypartner_id, t.outbank_id, t.inbank_id, 
    (to_days(now()) - to_days(t.bill_date) - IFNULL((select x.credit_day from fn_customer_account x where x.customer_id = t.customer_id),0)) expected_days
    from sa_customer_bill t
    where t.is_del = 0
    <if test="customerId != null">
      and t.customer_id = #{customerId,jdbcType=VARCHAR}
    </if>
    <if test="partnerId != null">
      and t.partner_id = #{partnerId,jdbcType=VARCHAR}
    </if>
    <if test="status != null">
      and t.status = #{status,jdbcType=VARCHAR}
    </if>
    <if test="invoiceIscomplete != null">
	  and t.invoice_iscomplete = #{invoiceIscomplete,jdbcType=BIT}
	</if>
	<if test="isExpected != null">
	  and t.status in (1,2) <!-- 账单状态:1、待审;2、确认;3、核销 -->
	  and to_days(now()) - to_days(t.bill_date) - ifnull((select x.credit_day from fn_customer_account x where x.customer_id = t.customer_id),0) > 0
	</if>
    order by t.create_time desc
  </select>
  
  <!-- 全量插入 -->
  <insert id="insert" parameterType="com.shiwulian.wechat.bean.sa.CustomerBill">
    insert into sa_customer_bill (id, bill_code, bill_date, 
      period_date, customer_id, partner_id, 
      amount, status, confirm_time, 
      confirm_operator, pay_time, pay_operator, 
      invoice_id, create_operator, create_time, 
      upt_operator, upt_time, is_del,
      currency_id, invoice_amount, invoice_iscomplete, bill_type, paypartner_id, outbank_id, inbank_id
    )
    values (#{id,jdbcType=VARCHAR}, #{billCode,jdbcType=VARCHAR}, #{billDate,jdbcType=DATE}, 
      #{periodDate,jdbcType=DATE}, #{customerId,jdbcType=VARCHAR}, #{partnerId,jdbcType=VARCHAR}, 
      #{amount,jdbcType=DECIMAL}, #{status,jdbcType=INTEGER}, #{confirmTime,jdbcType=TIMESTAMP}, 
      #{confirmOperator,jdbcType=VARCHAR}, #{payTime,jdbcType=TIMESTAMP}, #{payOperator,jdbcType=VARCHAR}, 
      #{invoiceId,jdbcType=VARCHAR}, #{createOperator,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{uptOperator,jdbcType=VARCHAR}, #{uptTime,jdbcType=TIMESTAMP}, #{isDel,jdbcType=BIT},
      #{currencyId,jdbcType=INTEGER}, #{invoiceAmount,jdbcType=DECIMAL}, #{invoiceIscomplete,jdbcType=BIT}, #{billType,jdbcType=BIT},
      #{paypartnerId,jdbcType=VARCHAR}, #{outbankId,jdbcType=VARCHAR}, #{inbankId,jdbcType=VARCHAR}
    )
  </insert>
  
  <!--条件插入-->
  <insert id="insertSelective" parameterType="com.shiwulian.wechat.bean.sa.CustomerBill">
    insert into sa_customer_bill
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="billCode != null">
        bill_code,
      </if>
      <if test="billDate != null">
        bill_date,
      </if>
      <if test="periodDate != null">
        period_date,
      </if>
      <if test="customerId != null">
        customer_id,
      </if>
      <if test="partnerId != null">
        partner_id,
      </if>
      <if test="amount != null">
        amount,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="confirmTime != null">
        confirm_time,
      </if>
      <if test="confirmOperator != null">
        confirm_operator,
      </if>
      <if test="payTime != null">
        pay_time,
      </if>
      <if test="payOperator != null">
        pay_operator,
      </if>
      <if test="invoiceId != null">
        invoice_id,
      </if>
      <if test="createOperator != null">
        create_operator,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="uptOperator != null">
        upt_operator,
      </if>
      <if test="uptTime != null">
        upt_time,
      </if>
      <if test="isDel != null">
        is_del,
      </if>
      <if test="currencyId != null">
        currency_id,
      </if>
      <if test="invoiceAmount != null">
        invoice_amount,
      </if>
      <if test="invoiceIscomplete != null">
        invoice_iscomplete,
      </if>
      <if test="billType != null">
        bill_type,
      </if>
      <if test="paypartnerId != null">
        paypartner_id,
      </if>
      <if test="outbankId != null">
        outbank_id,
      </if>
      <if test="inbankId != null">
        inbank_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="billCode != null">
        #{billCode,jdbcType=VARCHAR},
      </if>
      <if test="billDate != null">
        #{billDate,jdbcType=DATE},
      </if>
      <if test="periodDate != null">
        #{periodDate,jdbcType=DATE},
      </if>
      <if test="customerId != null">
        #{customerId,jdbcType=VARCHAR},
      </if>
      <if test="partnerId != null">
        #{partnerId,jdbcType=VARCHAR},
      </if>
      <if test="amount != null">
        #{amount,jdbcType=DECIMAL},
      </if>
      <if test="status != null">
        #{status,jdbcType=INTEGER},
      </if>
      <if test="confirmTime != null">
        #{confirmTime,jdbcType=TIMESTAMP},
      </if>
      <if test="confirmOperator != null">
        #{confirmOperator,jdbcType=VARCHAR},
      </if>
      <if test="payTime != null">
        #{payTime,jdbcType=TIMESTAMP},
      </if>
      <if test="payOperator != null">
        #{payOperator,jdbcType=VARCHAR},
      </if>
      <if test="invoiceId != null">
        #{invoiceId,jdbcType=VARCHAR},
      </if>
      <if test="createOperator != null">
        #{createOperator,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="uptOperator != null">
        #{uptOperator,jdbcType=VARCHAR},
      </if>
      <if test="uptTime != null">
        #{uptTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isDel != null">
        #{isDel,jdbcType=BIT},
      </if>
      <if test="currencyId != null">
        #{currencyId,jdbcType=INTEGER},
      </if>
      <if test="invoiceAmount != null">
        #{invoiceAmount,jdbcType=DECIMAL},
      </if>
      <if test="invoiceIscomplete != null">
        #{invoiceIscomplete,jdbcType=BIT}, 
      </if>
      <if test="billType != null">
        #{billType,jdbcType=BIT},
      </if>
      <if test="paypartnerId != null">
       #{paypartnerId,jdbcType=VARCHAR},
      </if>
      <if test="outbankId != null">
        #{outbankId,jdbcType=VARCHAR},
      </if>
      <if test="inbankId != null">
        #{inbankId,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  
  <!--全量更新  -->
  <update id="updateByPrimaryKey" parameterType="com.shiwulian.wechat.bean.sa.CustomerBill">
    update sa_customer_bill
    set bill_code = #{billCode,jdbcType=VARCHAR},
      bill_date = #{billDate,jdbcType=DATE},
      period_date = #{periodDate,jdbcType=DATE},
      customer_id = #{customerId,jdbcType=VARCHAR},
      partner_id = #{partnerId,jdbcType=VARCHAR},
      amount = #{amount,jdbcType=DECIMAL},
      status = #{status,jdbcType=INTEGER},
      confirm_time = #{confirmTime,jdbcType=TIMESTAMP},
      confirm_operator = #{confirmOperator,jdbcType=VARCHAR},
      pay_time = #{payTime,jdbcType=TIMESTAMP},
      pay_operator = #{payOperator,jdbcType=VARCHAR},
      invoice_id = #{invoiceId,jdbcType=VARCHAR},
      create_operator = #{createOperator,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      upt_operator = #{uptOperator,jdbcType=VARCHAR},
      upt_time = #{uptTime,jdbcType=TIMESTAMP},
      is_del = #{isDel,jdbcType=BIT},
      currency_id = #{currencyId,jdbcType=INTEGER},
      invoice_amount = #{invoiceAmount,jdbcType=DECIMAL},
      invoice_iscomplete = #{invoiceIscomplete,jdbcType=BIT}, 
      bill_type = #{billType,jdbcType=BIT},
      paypartner_id = #{paypartnerId,jdbcType=VARCHAR},
      outbank_id = #{outbankId,jdbcType=VARCHAR},
      inbank_id = #{inbankId,jdbcType=VARCHAR}
    where id = #{id,jdbcType=VARCHAR}
  </update>
  
  <!-- 条件更新 -->
  <update id="updateByPrimaryKeySelective" parameterType="com.shiwulian.wechat.bean.sa.CustomerBill">
    update sa_customer_bill
    <set>
      <if test="billCode != null">
        bill_code = #{billCode,jdbcType=VARCHAR},
      </if>
      <if test="billDate != null">
        bill_date = #{billDate,jdbcType=DATE},
      </if>
      <if test="periodDate != null">
        period_date = #{periodDate,jdbcType=DATE},
      </if>
      <if test="customerId != null">
        customer_id = #{customerId,jdbcType=VARCHAR},
      </if>
      <if test="partnerId != null">
        partner_id = #{partnerId,jdbcType=VARCHAR},
      </if>
      <if test="amount != null">
        amount = #{amount,jdbcType=DECIMAL},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="confirmTime != null">
        confirm_time = #{confirmTime,jdbcType=TIMESTAMP},
      </if>
      <if test="confirmOperator != null">
        confirm_operator = #{confirmOperator,jdbcType=VARCHAR},
      </if>
      <if test="payTime != null">
        pay_time = #{payTime,jdbcType=TIMESTAMP},
      </if>
      <if test="payOperator != null">
        pay_operator = #{payOperator,jdbcType=VARCHAR},
      </if>
      <if test="invoiceId != null">
        invoice_id = #{invoiceId,jdbcType=VARCHAR},
      </if>
      <if test="createOperator != null">
        create_operator = #{createOperator,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="uptOperator != null">
        upt_operator = #{uptOperator,jdbcType=VARCHAR},
      </if>
      <if test="uptTime != null">
        upt_time = #{uptTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isDel != null">
        is_del = #{isDel,jdbcType=BIT},
      </if>
      <if test="currencyId != null">
        currency_id = #{currencyId,jdbcType=INTEGER},
      </if>
      <if test="invoiceAmount != null">
        invoice_amount = #{invoiceAmount,jdbcType=DECIMAL},
      </if>
      <if test="invoiceIscomplete != null">
        invoice_iscomplete = #{invoiceIscomplete,jdbcType=BIT}, 
      </if>
      <if test="billType != null">
        bill_type = #{billType,jdbcType=BIT},
      </if>
      <if test="paypartnerId != null">
        paypartner_id = #{paypartnerId,jdbcType=VARCHAR},
      </if>
      <if test="outbankId != null">
        outbank_id = #{outbankId,jdbcType=VARCHAR},
      </if>
      <if test="inbankId != null">
        inbank_id = #{inbankId,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  
  <!-- 按主键删除 -->
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    delete from sa_customer_bill
    where id = #{id,jdbcType=VARCHAR}
  </delete>
  
</mapper>